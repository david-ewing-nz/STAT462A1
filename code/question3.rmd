

# ---------------------------

## Description

```{r possum-map, echo=FALSE, out.width="70%", fig.align='center'}
  # Load data-set and visualise
  knitr::include_graphics("../images/possum_age_plot.png")

```


## Load Data

```{r load-possums, include=F, eval=F}

# Load and preprocess data-set
# Performed in framework file as agreed 20250313
zip_path <- "../data/datasets.zip"
file.exists(zip_path)
possums <- read.csv(unz(zip_path, "possums.csv"))

```

## EDA - Data Cleaning and  Initial Analysis

```{r possums-EDA-start, include=T , eval=T}

set.seed(82171165) 
pskim   <- skim(possums) |> select(skim_variable, n_missing)
print(pskim)                           
head(possums)    
summary(possums)
  
```

```{r possum-clean-age}

possums_0 <- possums |> drop_na(age)   # drop missing age       
possums_0 <- remove_outliers(possums_0,"age")
# visualise age 
ggplot(possums_0, aes(x = age)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black") +
  ggtitle("Possum Ages Distribution") +
  theme_minimal()

```

```{r get-yaml-params, include=T}

# Access pthreshold from YAML params
pthreshold   <- NULL                                            # reset
pthreshold   <- params$pthreshold                               # from yaml parameters
if (is.null(pthreshold) || length(pthreshold) == 0) {           # If NULL or empty, assign default
  pthreshold <- 0.2                                             # use default
  message("⚠️ pthreshold set to default: ", pthreshold, " as header value was invalid.")
} else {
  pthreshold <- as.numeric(pthreshold)                          # numeric value
}

cat("pthreshold: ", pthreshold)

```

```{r select-possum-participants}

possums_2    <- possums_0 |> relocate(age, .after = last_col()) # age is last for ease of analysis 
 
pnumerics    <- possums_2 |> select(where(is.numeric))          # only use numeric columns
pmatrix      <- cor(pnumerics, use = "complete.obs")            # compute correlation matrix
ppredictors  <- pmatrix["age", ]                                # matrix values relative to age 
ggcorr(pnumerics, label = TRUE)                                 # visualise correlation matrix 

pfilter      <- abs(ppredictors) >= pthreshold & names(ppredictors) != "age"  #bool list of participants 
ppnames      <- names(ppredictors[pfilter])                     # named list of participants.  
possums_3    <- possums_2                                       # copy for cleanup the participant columns
for (col in ppnames) {                                          # cleanup outliers and na
  possums_3  <- possums_3 |> drop_na(col)                        # drop na rows of participants
  if (is.numeric(possums_3[[col]])) {
      possums_3 <- remove_outliers(possums_3, col)              # remove outliers for participants
    }
 }
possums_3 <- possums_3 |> mutate(female = ifelse(sex == "f", 1, 0))

if (length(ppnames) == 0) {
  pformula <- as.formula("age ~ 1")                           # default formula : intercept-only 
} else {
  pformula <- as.formula(paste("age ~", paste(ppnames, collapse=" + ")))   
}


```






```{r possum-lm-analysis, include=T}

plinear_m2 <- lm(pformula, data = possums_2)
plinear_m3 <- lm(pformula, data = possums_3)

summary(plinear_m2)   # with    outliers
summary(plinear_m3)   # without outliers

par(mfrow = c(2, 4))  # Arrange plots in 2x4 grid
plot(plinear_m2)
plot(plinear_m3)

```
## Feature Selection and Model Training



## Model Evaluation

```{r}
# Residuals vs. Leverage plot shows potential high-leverage points, which may be influencing the model too much

# Compute evaluation metrics
```

## Further Exploration

```{r}
# Additional analysis or research questions
```
