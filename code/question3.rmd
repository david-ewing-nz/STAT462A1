
# ---------------------------

## Description

```{r possum-map, echo=FALSE, out.width="70%", fig.align='center'}
  # Load data-set and visualise
  knitr::include_graphics("../images/possum_age_plot.png")

```


## Load Data

```{r load-possums, include=F, eval=T}
# Load and preprocess data-set
  zip_path <- "../data/datasets.zip"
  file.exists(zip_path)
  possums <- read.csv(unz(zip_path, "possums.csv"))
  
  set.seed(82171165) 

```

## EDA - Data Cleaning and  Initial Analysis
```{r possums-EDA, include=T , eval=T}

  pskim   <- skim(possums) |> select(skim_variable, n_missing)
  print(pskim)                           
  head(possums)    
  summary(possums)
  
```

```{r possum-datacleaning}

remove_outliers <- function(df, col) {        
  outliers <- boxplot.stats(df[[col]])$out  #  outliers
  if (length(outliers) > 0) {               #  remove if outliers 
    df <- df |> filter(!(df[[col]] %in% outliers))
  }
  return(df)
}

possums_0 <- possums |> drop_na(age)   # drop missing age       

# visualise age 
ggplot(possums_0, aes(x = age)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black") +
  ggtitle("Possum Ages Distribution") +
  theme_minimal()

# Identify outliers
outliers <- boxplot.stats(possums_0$age)$out # wiskers
print(outliers)

# possums_1 contains chunk result
possums_1 = NULL
if (length(outliers) > 0) {
  possums_1 <- remove_outliers(possums_0, "age")
  message("outliers found/removed.")
} else {
  possums_1 <- possums_0  # Keep possums_0 
  message("no outliers.")
}

```







```{r select-possum-predictors, include=T}

# Access pthreshold from YAML params
pthreshold   <- NULL                                            # reset
pthreshold   <- params$pthreshold                               # as text for testing
if (is.null(pthreshold) || length(pthreshold) == 0) {           # If NULL or empty, assign default
  pthreshold <- 0.2                                             # use default
  message("⚠️ pthreshold set to default: ", pthreshold, " as header value was invalid.")
} else {
  pthreshold <- as.numeric(pthreshold)                          # numeric value
}

cat("pthreshold: ", pthreshold)
possums_2    <- possums_1 |> relocate(age, .after = last_col()) # age is last
pnumerics    <- possums_2 |> select(where(is.numeric))        # only use numeric columns
pmatrix      <- cor(pnumerics, use = "complete.obs")            # compute correlation matrix
ppredictors  <- pmatrix["age", ]                                # values relative to age 
ggcorr(pnumerics, label = TRUE)                                 # visualise correlation matrix 




```

```{r possum-rinse-and-repeat, include=T}
# filter string
#
pfilter      <- abs(ppredictors) >= pthreshold & names(ppredictors) != "age"

ppnames      <- names(ppredictors[pfilter])              # now we know the names of the columns to use.        
pnumerics_   <- pnumerics[, c(ppnames, "age"), drop = FALSE]

#pnames_na <- c(ppnames, "age") # Include age to keep th
ggcorr(pnumerics_, label = TRUE)                                 # visualise correlation matrix 
```

```{r possum-numeric-sex}

if (length(ppnames) == 0) {
  pformula   <- as.formula("age ~ 1")                           # default formula : intercept-only 
} else {
  pformula   <- as.formula(paste("age ~", paste(ppnames, collapse=" + ")))   
}

for (col in ppnames) {
  possums_tmp <- remove_outliers(possums_tmp, col)
}

```



```{r possum-lm-analysis, include=T}

plinear_m1 <- lm(pformula, data = possums_tm1)
plinear_m2 <- lm(pformula, data = possums_tmp)

summary(plinear_m1)   # with    outliers
summary(plinear_m2)   # without outliers

par(mfrow = c(2, 4))  # Arrange plots in 2x4 grid
plot(plinear_m1)
plot(plinear_m2)



```
## Feature Selection and Model Training

```{r}
possums_3 <- possums_2 |> mutate(sex = ifelse(sex == "f", 1, 0)) #sex converted to numeric


# Forward feature selection and model training
```

## Model Evaluation

```{r}
# Residuals vs. Leverage plot shows potential high-leverage points, which may be influencing the model too much

# Compute evaluation metrics
```

## Further Exploration

```{r}
# Additional analysis or research questions
```
