

# ---------------------------

## Description

```{r possum-map, echo=FALSE, out.width="70%", fig.align='center'}
  # Load data-set and visualise
  knitr::include_graphics("../images/possum_age_plot.png")

```
## Discription

```{r question3-status, include=F, eval=T}
# created with the help of ChatGPT as this is not a deliverable. 
# dataframe with workflow steps
pdf_workflow <- data.frame(
  Step = c(      "1. initial analysis", 
                 "2. Exploratory Data Analysis", 
                 "3. Initial Feature Selection", 
                 "4. Model Evaluation", 
                 "5. Refinement of Selected Model", 
                 "6. Performance Testing"),

  Process = c(   "Remove irrelevant columns (`case`, `Pop`), encode categorical variables", 
                 "Check missing values, correlation analysis (`cor()`, `ggcorr()`)", 
                 "Use `stepAIC()` (forward selection) to select key predictors", 
                 "Check significance (`summary()`), check multicollinearity (`vif()`)", 
                 "Decide whether to keep/remove non-significant predictors (`hdlngth`)", 
                 "Compute MSE, residual analysis, compare with alternative models"),
  
  Status = c( " Done", 
              " Done but revisitiong", 
              " Done (`belly`, `hdlngth` selected)", 
              " Done (`vif < 5`, no multicollinearity)", 
              " In progress", 
              " Not done yet")
)
ptable_workflow <- flextable(pdf_workflow) |>
  theme_box() |>  # Apply box theme for automatic borders
  set_table_properties(layout = "fixed") |>  # Allow text to wrap
  width(j = 1, width = 2) |>  # Step column (narrow)
  width(j = 2, width = 3) |>  # Process column (text wraps naturally)
  width(j = 3, width = 2) |>  # Status column (smallest)
  bg(part = "header", bg = "#D3D3D3") |>  # Grey background for header row
  bg(i = NULL, j = 1, bg = "#D3D3D3", part = "body") |>  # Grey background for first column
  color(j = 3, color = "blue") |>  # Color status column text blue
  bold(j = 1) |>  # Bold the "Step" column
  align(j = 1, align = "left", part = "all") |>  # Left-align first column
  fontsize(size = 9)  

# status within the group
ptable_workflow


```

```{r}
ptable_workflow
```


## Load Data

```{r load-possums, include=F, eval=F}

# Load and preprocess data-set
# Performed in framework file as agreed 20250313
zip_path <- "../data/datasets.zip"
file.exists(zip_path)
possums <- read.csv(unz(zip_path, "possums.csv"))

```

## EDA - Data Cleaning and  Initial Analysis

```{r possums-EDA-prep, include=T , eval=T}

set.seed(82171165) 
pskim   <- skim(possums) |> select(skim_variable, n_missing)
print(pskim)                           
head(possums)    
summary(possums)

# possums_0 is the working copy of possums
# we will:
#  drop case - as this is just a numeric row index
#  drop Pop - it is redundant as we have site. 
#  relocate age to the last column for ease of analysis 
#  impute missing data 
#  capture numeric predictors before altering sex or site
#  mutate sex to numberic where female = 1
#  convert site to a factor
#
possums_0 <- subset(possums, select = -c(case, Pop))           # drop case and Pop
possums_0 <- mice(possums_0, m=1, method="mean") |> complete() # impute
possums_0 <- possums_0 |> relocate(age, .after = last_col())   # age is last 
names(possums_0)                                               # just checking
pred_names_0   <- possums_0 |> select(where(is.numeric)) |>  select(-age) |> names() 
possums_0$sex  <- as.numeric(possums_0$sex == "f")  # true if female
possums_0$site <- as.factor(possums_0$site)
```

```{r visualise-age}

# visualise age 
ggplot(possums_0, aes(x = age)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black") +
  ggtitle("Possum Ages Distribution (imputed and without outliers)") +
  theme_minimal()

```

```{r possum-data-splitting}

# data-splitting is performed before cleaning predictors 
# to simulate real-world events. 
# 

# possums_1 is the training possum data (with stratification for age)
#
pTrainIdx <- createDataPartition(possums_0$age, p = 0.8, list = FALSE)
possums_1 <- possums_0[pTrainIdx, ]

# pTestDf is the test possum data           (with stratification)
# pValidateDf is the validation possum data (with stratification) 
#
pTempDf     <- possums_0[-pTrainIdx, ]  #not train
pTestIdx    <- createDataPartition(pTempDf$age, p = 0.5, list = FALSE) 
pTestDf     <- pTempDf[pTestIdx, ]   
pValidateDf <- pTempDf[-pTestIdx, ]

cat("\npossums_1:   ", nrow(possums_1), "\npTestDf:     ", nrow(pTestDf), "\nVpValidateDf: ", nrow(pValidateDf),"\n")

```


\newpage
## Feature Selection and Model Training



## Model Evaluation

```{r}
# Residuals vs. Leverage plot shows potential high-leverage points, which may be influencing the model too much

# Compute evaluation metrics
```

## Further Exploration

```{r}
# Additional analysis or research questions 
#[204]
```
