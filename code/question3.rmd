
# ---------------------------

## Description

```{r possum-map, echo=FALSE, out.width="70%", fig.align='center'}
  # Load data-set and visualise
  knitr::include_graphics("../images/possum_age_plot.png")

```


## Data Preparation

```{r load-possums, include=FALSE, eval=T}
# Load and preprocess data-set
  zip_path <- "../data/datasets.zip"
  file.exists(zip_path)
  possums <- read.csv(unz(zip_path, "possums.csv"))
  skimp   <- skim(possums) |> select(skim_variable, n_missing)
  print(skimp)                           
  head(possums)    
  summary(possums)
```

## Data Cleaning and  Initial Analysis
```{r analyse-possums, include=T , eval=T}

remove_outliers <- function(df, col) {        
  outliers <- boxplot.stats(df[[col]])$out  #  outliers
  if (length(outliers) > 0) {               #  remove if outliers 
    df <- df |> filter(!(df[[col]] %in% outliers))
  }
  return(df)
}


possums_0 <- possums |> drop_na(age)   # drop missing age       

# visualise age 
ggplot(possums_0, aes(x = age)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black") +
  ggtitle("Possum Ages Distribution") +
  theme_minimal()

# Identify outliers
outliers <- boxplot.stats(possums_0$age)$out # wiskers
print(outliers)

# possums_1 contains chunk result
if (length(outliers) > 0) {
  possums_1 <- remove_outliers(possums_0, "age")
  message("outliers found/removed.")
} else {
  possums_1 <- possums_0  # Keep possums_0 
  message("no outliers.")
}

```




```{r select-possum-predictors, include=T}


# Access pthreshold from YAML params
pthreshold   <- NULL
pthreshold   <- as.numeric(params$pthreshold) 
posssums_tmp <- possums_1 |> relocate(age, .after = last_col()) # age is last
pnumerics    <- posssums_tmp |> select(where(is.numeric))       # only use numeric values
pmatrix      <- cor(pnumerics, use = "complete.obs")            # compute correlation matrix
ppredictors  <- pmatrix["age", ]                                # values relative to age 
ggcorr(pnumerics, label = TRUE)                                 # visualise correlation matrix 
if (is.null(pthreshold) || length(pthreshold) == 0) {           # If NULL or empty, assign default
  pthreshold <- 0.2  # Set default
}  
pfilter      <- abs(ppredictors) >= pthreshold & names(ppredictors) != "age"
ppnames      <- names(ppredictors[pfilter])                     #  now we know the names of the columns to use. 



pnames_na    <- c(ppnames, "age")                               # Include age to keep the 

pformula     <- as.formula(paste("age ~", paste(ppnames, collapse=" + ")))
```

```{r possum-repeat-clean, include=T}

for (col in ppnames) {
  posssums_tmp <- remove_outliers(posssums_tmp, col)
}


plinear_m    <- lm(pformula, data = posssums_tmp)
summary(plinear_m)
```


```{r residual-analysis, include=T}
par(mfrow = c(2, 2))  # Arrange plots in 2x2 grid
plot(plinear_m)

## Feature Selection and Model Training

```{r}
# Forward feature selection and model training
```

## Model Evaluation

```{r}
# Residuals vs. Leverage plot shows potential high-leverage points, which may be influencing the model too much

# Compute evaluation metrics
```

## Further Exploration

```{r}
# Additional analysis or research questions
```
